<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSF 实时流式播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      @layer base {
        :root {
          --background: 0 0% 100%;
          --foreground: 222.2 84% 4.9%;
          --card: 0 0% 100%;
          --card-foreground: 222.2 84% 4.9%;
          --popover: 0 0% 100%;
          --popover-foreground: 222.2 84% 4.9%;
          --primary: 221.2 83.2% 53.3%;
          --primary-foreground: 210 40% 98%;
          --secondary: 210 40% 96%;
          --secondary-foreground: 222.2 84% 4.9%;
          --muted: 210 40% 96%;
          --muted-foreground: 215.4 16.3% 46.9%;
          --accent: 210 40% 96%;
          --accent-foreground: 222.2 84% 4.9%;
          --destructive: 0 84.2% 60.2%;
          --destructive-foreground: 210 40% 98%;
          --border: 214.3 31.8% 91.4%;
          --input: 214.3 31.8% 91.4%;
          --ring: 221.2 83.2% 53.3%;
          --radius: 0.5rem;
        }
      }
      @layer base {
        * {
          @apply border-border;
        }
        body {
          @apply bg-background text-foreground;
          @apply bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-white;
          font-family: system-ui, -apple-system, sans-serif;
        }
      }
      @layer components {
        .container {
          @apply bg-white/10 backdrop-blur-md rounded-xl p-5 my-4 border border-white/20;
        }
        .btn {
          @apply inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50;
          @apply bg-primary text-primary-foreground hover:bg-primary/90;
          @apply h-10 px-4 py-2;
          @apply shadow-lg hover:shadow-xl hover:-translate-y-0.5;
        }
        .btn-play {
          @apply bg-red-500 hover:bg-red-600 text-lg px-6 py-3;
        }
        .btn-stop {
          @apply bg-orange-500 hover:bg-orange-600;
        }
        .file-input {
          @apply bg-white/10 border-2 border-dashed border-white/30 rounded-lg p-5 text-white w-full my-2.5 cursor-pointer;
        }
        .status-info {
          @apply bg-blue-500/30 border-l-4 border-blue-400;
        }
        .status-success {
          @apply bg-green-500/30 border-l-4 border-green-400;
        }
        .status-error {
          @apply bg-red-500/30 border-l-4 border-red-400;
        }
        .status {
          @apply p-4 my-2.5 rounded-lg backdrop-blur-sm;
        }
        .controls {
          @apply flex items-center gap-4 my-4 flex-wrap;
        }
        .volume-control {
          @apply flex items-center gap-2.5;
        }
        .slider {
          @apply flex-1 h-1.5 rounded-lg bg-white/30 outline-none;
        }
        .track-info {
          @apply bg-black/20 p-4 rounded-lg my-4;
        }
        .waveform {
          @apply w-full h-20 bg-black/30 rounded-lg my-4;
        }
        .select {
          @apply bg-white/10 text-white border border-white/30 rounded-md px-2 py-1.5;
        }
      }
    </style>
</head>
<body class="min-h-screen font-sans antialiased">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <main>
            <section class="container">
                <h2 class="text-xl font-semibold mb-4">选择NSF文件</h2>
                <div class="space-y-4">
                    <input type="file" id="nsfFile" accept=".nsf,.nsfe" class="file-input" onchange="loadNSF()" />
                </div>
            </section>

            <section id="infoContainer" class="container hidden">
                <h2 class="text-xl font-semibold mb-4">文件信息</h2>
                <div id="nsfInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                
                <div class="controls flex-col md:flex-row gap-6">
                    <div class="flex items-center space-x-2">
                        <label for="trackSelect" class="text-sm font-medium">轨道:</label>
                        <select id="trackSelect" class="select w-full"></select>
                    </div>
                    <div class="volume-control w-full md:w-auto">
                        <label for="volumeSlider" class="text-sm font-medium">音量:</label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="70" class="slider">
                        <span id="volumeValue" class="text-sm font-medium w-12 text-right">70%</span>
                    </div>
                </div>
            </section>

            <section id="playerContainer" class="container hidden">
                <h2 class="text-xl font-semibold mb-4">实时播放控制</h2>
                <div class="controls">
                    <button id="playBtn" onclick="togglePlay()" class="btn btn-play">▶️ 播放</button>
                    <button onclick="stopPlay()" class="btn btn-stop">⏹️ 停止</button>
                    <button onclick="prevTrack()" class="btn">⏮️ 上一首</button>
                    <button onclick="nextTrack()" class="btn">⏭️ 下一首</button>
                </div>
                
                <canvas id="waveform" class="waveform"></canvas>
                
                <div class="track-info grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><strong>状态:</strong> <span id="playStatus" class="font-mono">已停止</span></div>
                    <div><strong>当前轨道:</strong> <span id="currentTrack" class="font-mono">-</span></div>
                    <div><strong>播放时间:</strong> <span id="playTime" class="font-mono">00:00</span></div>
                    <div><strong>缓冲状态:</strong> <span id="bufferStatus" class="font-mono">-</span></div>
                </div>
            </section>
        </main>

        <footer id="statusContainer" class="mt-8"></footer>
    </div>

    <script>
        let nsfPlayer = null;
        let nsfInfo = null;
        let audioContext = null;
        let scriptProcessor = null;
        let gainNode = null;
        let isPlaying = false;
        let currentTrack = 1;
        let playStartTime = 0;
        let audioBuffer = [];
        let bufferSize = 4096;
        let sampleRate = 44100;
        let channels = 2;

        // 显示状态
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            let statusClass = 'status-info';
            if (type === 'success') statusClass = 'status-success';
            if (type === 'error') statusClass = 'status-error';
            container.innerHTML = `<div class="status ${statusClass}">${message}</div>`;
        }

        // 初始化WebAssembly
        async function initWasm() {
            if (nsfPlayer) return true;
            
            try {
                const script = document.createElement('script');
                script.src = './build/nsf2wav_wasm.js';
                
                return new Promise((resolve, reject) => {
                    script.onload = async () => {
                        try {
                            nsfPlayer = await NSFPlayer();
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                            if (!nsfPlayer.ccall || !nsfPlayer._malloc || !nsfPlayer.HEAPU8) {
                                throw new Error('WebAssembly模块未完全初始化');
                            }
                            
                            console.log('WebAssembly模块加载成功');
                            resolve(true);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            } catch (error) {
                showStatus('初始化失败: ' + error.message, 'error');
                return false;
            }
        }

        // 初始化Web Audio API
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: sampleRate
                });
                
                // 创建音频处理节点
                scriptProcessor = audioContext.createScriptProcessor(bufferSize, 0, channels);
                
                // 创建增益节点用于音量控制
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0.7;
                
                // 连接音频节点
                scriptProcessor.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 音频处理回调
                scriptProcessor.onaudioprocess = function(audioProcessingEvent) {
                    if (!isPlaying) {
                        // 输出静音
                        for (let channel = 0; channel < channels; channel++) {
                            const outputBuffer = audioProcessingEvent.outputBuffer.getChannelData(channel);
                            for (let sample = 0; sample < bufferSize; sample++) {
                                outputBuffer[sample] = 0;
                            }
                        }
                        return;
                    }
                    
                    // 生成音频数据
                    generateAudioData(audioProcessingEvent.outputBuffer);
                };
                
                // 音量控制
                const volumeSlider = document.getElementById('volumeSlider');
                const volumeValue = document.getElementById('volumeValue');
                
                volumeSlider.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    gainNode.gain.value = volume;
                    volumeValue.textContent = e.target.value + '%';
                });
                
                console.log('Web Audio API初始化成功');
                return true;
            } catch (error) {
                console.error('Web Audio API初始化失败:', error);
                showStatus('音频系统初始化失败: ' + error.message, 'error');
                return false;
            }
        }

        // 生成音频数据
        function generateAudioData(outputBuffer) {
            if (!nsfPlayer || !isPlaying) return;
            
            try {
                // 分配内存用于音频数据
                const frameCount = bufferSize;
                const audioDataSize = frameCount * channels * 2; // 16位立体声
                const audioPtr = nsfPlayer._malloc(audioDataSize);
                
                // 调用WebAssembly函数生成音频
                const result = nsfPlayer.ccall('nsf_render_audio', 'number',
                    ['number', 'number', 'number'], [currentTrack, frameCount, audioPtr]);
                
                if (result > 0) {
                    // 读取生成的音频数据
                    const int16Data = new Int16Array(nsfPlayer.HEAPU8.buffer, audioPtr, frameCount * channels);
                    
                    // 转换为Float32并填充输出缓冲区
                    for (let channel = 0; channel < channels; channel++) {
                        const outputData = outputBuffer.getChannelData(channel);
                        for (let sample = 0; sample < frameCount; sample++) {
                            const sampleIndex = sample * channels + channel;
                            outputData[sample] = int16Data[sampleIndex] / 32768.0;
                        }
                    }
                    
                    // 更新波形显示
                    updateWaveform(outputBuffer.getChannelData(0));
                } else {
                    // 如果没有数据，输出静音
                    for (let channel = 0; channel < channels; channel++) {
                        const outputData = outputBuffer.getChannelData(channel);
                        outputData.fill(0);
                    }
                }
                
                nsfPlayer._free(audioPtr);
                
            } catch (error) {
                console.error('音频生成错误:', error);
                // 输出静音
                for (let channel = 0; channel < channels; channel++) {
                    const outputData = outputBuffer.getChannelData(channel);
                    outputData.fill(0);
                }
            }
        }

        // 更新波形显示
        function updateWaveform(audioData) {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const sliceWidth = canvas.width / audioData.length;
            let x = 0;
            
            for (let i = 0; i < audioData.length; i++) {
                const v = audioData[i] * 0.5;
                const y = (v + 1) * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
        }

        // 加载NSF文件
        async function loadNSF() {
            const fileInput = document.getElementById('nsfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('请选择一个NSF文件', 'error');
                return;
            }

            showStatus('正在初始化...', 'info');
            if (!(await initWasm())) return;

            showStatus('正在加载NSF文件...', 'info');

            try {
                // 读取文件
                const arrayBuffer = await file.arrayBuffer();
                const nsfData = new Uint8Array(arrayBuffer);

                // 初始化播放器
                const initResult = nsfPlayer.ccall('init_nsf_player', 'number', [], []);
                if (!initResult) {
                    throw new Error('初始化NSF播放器失败');
                }

                // 加载数据
                const dataPtr = nsfPlayer._malloc(nsfData.length);
                nsfPlayer.HEAPU8.set(nsfData, dataPtr);
                const loadResult = nsfPlayer.ccall('load_nsf_data', 'number', 
                    ['number', 'number'], [dataPtr, nsfData.length]);
                nsfPlayer._free(dataPtr);

                if (!loadResult) {
                    throw new Error('加载NSF数据失败');
                }

                // 获取信息
                const infoPtr = nsfPlayer._malloc(1024);
                const infoResult = nsfPlayer.ccall('get_nsf_info', 'number', ['number'], [infoPtr]);

                if (infoResult) {
                    nsfInfo = {
                        title: nsfPlayer.UTF8ToString(infoPtr),
                        artist: nsfPlayer.UTF8ToString(infoPtr + 256),
                        copyright: nsfPlayer.UTF8ToString(infoPtr + 512),
                        totalSongs: nsfPlayer.getValue(infoPtr + 768, 'i32'),
                        defaultSong: nsfPlayer.getValue(infoPtr + 772, 'i32'),
                        lengthMs: nsfPlayer.getValue(infoPtr + 776, 'i32'),
                        fadeMs: nsfPlayer.getValue(infoPtr + 780, 'i32')
                    };

                    displayNSFInfo();
                    setupTrackSelector();
                    
                    // 初始化音频系统
                    if (await initAudio()) {
                        // 设置C++播放器参数
                        nsfPlayer.ccall('nsf_player_set_options', 'void', ['number', 'number'], [sampleRate, channels]);
                        
                        document.getElementById('playerContainer').classList.remove('hidden');
                        showStatus('NSF文件加载成功！可以开始实时播放了。', 'success');
                    }
                } else {
                    throw new Error('获取NSF信息失败');
                }

                nsfPlayer._free(infoPtr);

            } catch (error) {
                showStatus('加载失败: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        // 显示NSF信息
        function displayNSFInfo() {
            const infoDiv = document.getElementById('nsfInfo');
            infoDiv.innerHTML = `
                <div class="bg-black/20 p-3 rounded-lg"><strong>标题:</strong> ${nsfInfo.title || '未知'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>艺术家:</strong> ${nsfInfo.artist || '未知'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>版权:</strong> ${nsfInfo.copyright || '未知'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>轨道数:</strong> ${nsfInfo.totalSongs}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>默认轨道:</strong> ${nsfInfo.defaultSong + 1}</div>
            `;
            document.getElementById('infoContainer').classList.remove('hidden');
        }

        // 设置轨道选择器
        function setupTrackSelector() {
            const trackSelect = document.getElementById('trackSelect');
            trackSelect.innerHTML = '';
            
            for (let i = 1; i <= nsfInfo.totalSongs; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `轨道 ${i}`;
                option.className = 'bg-gray-800 text-white';
                if (i === nsfInfo.defaultSong + 1) {
                    option.selected = true;
                    currentTrack = i;
                }
                trackSelect.appendChild(option);
            }
            
            trackSelect.addEventListener('change', (e) => {
                const newTrack = parseInt(e.target.value);
                if (newTrack !== currentTrack) {
                    currentTrack = newTrack;
                    // 重置播放器到新轨道
                    if (nsfPlayer) {
                        nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                        nsfPlayer.ccall('nsf_reset', 'void', [], []);
                    }
                    updateCurrentTrackDisplay();
                }
            });
        }

        // 切换播放状态
        async function togglePlay() {
            if (!audioContext || !nsfPlayer) return;
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }

        // 开始播放
        function startPlay() {
            if (!nsfPlayer) return;
            
            isPlaying = true;
            playStartTime = Date.now();
            
            // 设置播放器
            nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
            nsfPlayer.ccall('nsf_reset', 'void', [], []);
            
            // 更新UI
            document.getElementById('playBtn').textContent = '⏸️ 暂停';
            document.getElementById('playStatus').textContent = '播放中';
            document.getElementById('currentTrack').textContent = `轨道 ${currentTrack}`;
            document.getElementById('bufferStatus').textContent = '实时生成';
            
            // 开始播放时间更新
            startPlayTimer();
            
            showStatus('开始实时播放...', 'success');
        }

        // 停止播放
        function stopPlay() {
            isPlaying = false;
            
            // 更新UI
            document.getElementById('playBtn').textContent = '▶️ 播放';
            document.getElementById('playStatus').textContent = '已停止';
            document.getElementById('playTime').textContent = '00:00';
            document.getElementById('bufferStatus').textContent = '-';
            
            stopPlayTimer();
            showStatus('播放已停止', 'info');
        }

        // 上一首
        function prevTrack() {
            if (currentTrack > 1) {
                currentTrack--;
                document.getElementById('trackSelect').value = currentTrack;
                if (nsfPlayer) {
                    nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                    nsfPlayer.ccall('nsf_reset', 'void', [], []);
                }
                updateCurrentTrackDisplay();
            }
        }

        // 下一首
        function nextTrack() {
            if (currentTrack < nsfInfo.totalSongs) {
                currentTrack++;
                document.getElementById('trackSelect').value = currentTrack;
                if (nsfPlayer) {
                    nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                    nsfPlayer.ccall('nsf_reset', 'void', [], []);
                }
                updateCurrentTrackDisplay();
            }
        }

        // 更新当前轨道显示
        function updateCurrentTrackDisplay() {
            document.getElementById('currentTrack').textContent = `轨道 ${currentTrack}`;
        }

        // 播放时间计时器
        let playTimer = null;

        function startPlayTimer() {
            playTimer = setInterval(() => {
                if (isPlaying) {
                    const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('playTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopPlayTimer() {
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            showStatus('准备就绪，请选择NSF文件开始实时播放');
        });

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            if (audioContext) {
                audioContext.close();
            }
            if (nsfPlayer) {
                nsfPlayer.ccall('cleanup', 'void', [], []);
            }
        });
    </script>
</body>
</html>
