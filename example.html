<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSF å®æ—¶æµå¼æ’­æ”¾å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      @layer base {
        :root {
          --background: 0 0% 100%;
          --foreground: 222.2 84% 4.9%;
          --card: 0 0% 100%;
          --card-foreground: 222.2 84% 4.9%;
          --popover: 0 0% 100%;
          --popover-foreground: 222.2 84% 4.9%;
          --primary: 221.2 83.2% 53.3%;
          --primary-foreground: 210 40% 98%;
          --secondary: 210 40% 96%;
          --secondary-foreground: 222.2 84% 4.9%;
          --muted: 210 40% 96%;
          --muted-foreground: 215.4 16.3% 46.9%;
          --accent: 210 40% 96%;
          --accent-foreground: 222.2 84% 4.9%;
          --destructive: 0 84.2% 60.2%;
          --destructive-foreground: 210 40% 98%;
          --border: 214.3 31.8% 91.4%;
          --input: 214.3 31.8% 91.4%;
          --ring: 221.2 83.2% 53.3%;
          --radius: 0.5rem;
        }
      }
      @layer base {
        * {
          @apply border-border;
        }
        body {
          @apply bg-background text-foreground;
          @apply bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-white;
          font-family: system-ui, -apple-system, sans-serif;
        }
      }
      @layer components {
        .container {
          @apply bg-white/10 backdrop-blur-md rounded-xl p-5 my-4 border border-white/20;
        }
        .btn {
          @apply inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50;
          @apply bg-primary text-primary-foreground hover:bg-primary/90;
          @apply h-10 px-4 py-2;
          @apply shadow-lg hover:shadow-xl hover:-translate-y-0.5;
        }
        .btn-play {
          @apply bg-red-500 hover:bg-red-600 text-lg px-6 py-3;
        }
        .btn-stop {
          @apply bg-orange-500 hover:bg-orange-600;
        }
        .file-input {
          @apply bg-white/10 border-2 border-dashed border-white/30 rounded-lg p-5 text-white w-full my-2.5 cursor-pointer;
        }
        .status-info {
          @apply bg-blue-500/30 border-l-4 border-blue-400;
        }
        .status-success {
          @apply bg-green-500/30 border-l-4 border-green-400;
        }
        .status-error {
          @apply bg-red-500/30 border-l-4 border-red-400;
        }
        .status {
          @apply p-4 my-2.5 rounded-lg backdrop-blur-sm;
        }
        .controls {
          @apply flex items-center gap-4 my-4 flex-wrap;
        }
        .volume-control {
          @apply flex items-center gap-2.5;
        }
        .slider {
          @apply flex-1 h-1.5 rounded-lg bg-white/30 outline-none;
        }
        .track-info {
          @apply bg-black/20 p-4 rounded-lg my-4;
        }
        .waveform {
          @apply w-full h-20 bg-black/30 rounded-lg my-4;
        }
        .select {
          @apply bg-white/10 text-white border border-white/30 rounded-md px-2 py-1.5;
        }
      }
    </style>
</head>
<body class="min-h-screen font-sans antialiased">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight">ğŸµ NSF å®æ—¶æµå¼æ’­æ”¾å™¨</h1>
        </header>

        <main>
            <section class="container">
                <h2 class="text-xl font-semibold mb-4">é€‰æ‹©NSFæ–‡ä»¶</h2>
                <div class="space-y-4">
                    <input type="file" id="nsfFile" accept=".nsf,.nsfe" class="file-input" />
                    <button onclick="loadNSF()" class="btn">åŠ è½½NSFæ–‡ä»¶</button>
                </div>
            </section>

            <section id="infoContainer" class="container hidden">
                <h2 class="text-xl font-semibold mb-4">æ–‡ä»¶ä¿¡æ¯</h2>
                <div id="nsfInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                
                <div class="controls flex-col md:flex-row gap-6">
                    <div class="flex items-center space-x-2">
                        <label for="trackSelect" class="text-sm font-medium">è½¨é“:</label>
                        <select id="trackSelect" class="select w-full"></select>
                    </div>
                    <div class="volume-control w-full md:w-auto">
                        <label for="volumeSlider" class="text-sm font-medium">éŸ³é‡:</label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="70" class="slider">
                        <span id="volumeValue" class="text-sm font-medium w-12 text-right">70%</span>
                    </div>
                </div>
            </section>

            <section id="playerContainer" class="container hidden">
                <h2 class="text-xl font-semibold mb-4">å®æ—¶æ’­æ”¾æ§åˆ¶</h2>
                <div class="controls">
                    <button id="playBtn" onclick="togglePlay()" class="btn btn-play">â–¶ï¸ æ’­æ”¾</button>
                    <button onclick="stopPlay()" class="btn btn-stop">â¹ï¸ åœæ­¢</button>
                    <button onclick="prevTrack()" class="btn">â®ï¸ ä¸Šä¸€é¦–</button>
                    <button onclick="nextTrack()" class="btn">â­ï¸ ä¸‹ä¸€é¦–</button>
                </div>
                
                <canvas id="waveform" class="waveform"></canvas>
                
                <div class="track-info grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><strong>çŠ¶æ€:</strong> <span id="playStatus" class="font-mono">å·²åœæ­¢</span></div>
                    <div><strong>å½“å‰è½¨é“:</strong> <span id="currentTrack" class="font-mono">-</span></div>
                    <div><strong>æ’­æ”¾æ—¶é—´:</strong> <span id="playTime" class="font-mono">00:00</span></div>
                    <div><strong>ç¼“å†²çŠ¶æ€:</strong> <span id="bufferStatus" class="font-mono">-</span></div>
                </div>
            </section>
        </main>

        <footer id="statusContainer" class="mt-8"></footer>
    </div>

    <script>
        let nsfPlayer = null;
        let nsfInfo = null;
        let audioContext = null;
        let scriptProcessor = null;
        let gainNode = null;
        let isPlaying = false;
        let currentTrack = 1;
        let playStartTime = 0;
        let audioBuffer = [];
        let bufferSize = 4096;
        let sampleRate = 44100;
        let channels = 2;

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            let statusClass = 'status-info';
            if (type === 'success') statusClass = 'status-success';
            if (type === 'error') statusClass = 'status-error';
            container.innerHTML = `<div class="status ${statusClass}">${message}</div>`;
        }

        // åˆå§‹åŒ–WebAssembly
        async function initWasm() {
            if (nsfPlayer) return true;
            
            try {
                const script = document.createElement('script');
                script.src = './build/nsf2wav_wasm.js';
                
                return new Promise((resolve, reject) => {
                    script.onload = async () => {
                        try {
                            nsfPlayer = await NSFPlayer();
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                            if (!nsfPlayer.ccall || !nsfPlayer._malloc || !nsfPlayer.HEAPU8) {
                                throw new Error('WebAssemblyæ¨¡å—æœªå®Œå…¨åˆå§‹åŒ–');
                            }
                            
                            console.log('WebAssemblyæ¨¡å—åŠ è½½æˆåŠŸ');
                            resolve(true);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            } catch (error) {
                showStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // åˆå§‹åŒ–Web Audio API
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: sampleRate
                });
                
                // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                scriptProcessor = audioContext.createScriptProcessor(bufferSize, 0, channels);
                
                // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ç”¨äºéŸ³é‡æ§åˆ¶
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0.7;
                
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                scriptProcessor.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // éŸ³é¢‘å¤„ç†å›è°ƒ
                scriptProcessor.onaudioprocess = function(audioProcessingEvent) {
                    if (!isPlaying) {
                        // è¾“å‡ºé™éŸ³
                        for (let channel = 0; channel < channels; channel++) {
                            const outputBuffer = audioProcessingEvent.outputBuffer.getChannelData(channel);
                            for (let sample = 0; sample < bufferSize; sample++) {
                                outputBuffer[sample] = 0;
                            }
                        }
                        return;
                    }
                    
                    // ç”ŸæˆéŸ³é¢‘æ•°æ®
                    generateAudioData(audioProcessingEvent.outputBuffer);
                };
                
                // éŸ³é‡æ§åˆ¶
                const volumeSlider = document.getElementById('volumeSlider');
                const volumeValue = document.getElementById('volumeValue');
                
                volumeSlider.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    gainNode.gain.value = volume;
                    volumeValue.textContent = e.target.value + '%';
                });
                
                console.log('Web Audio APIåˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('Web Audio APIåˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ç”ŸæˆéŸ³é¢‘æ•°æ®
        function generateAudioData(outputBuffer) {
            if (!nsfPlayer || !isPlaying) return;
            
            try {
                // åˆ†é…å†…å­˜ç”¨äºéŸ³é¢‘æ•°æ®
                const frameCount = bufferSize;
                const audioDataSize = frameCount * channels * 2; // 16ä½ç«‹ä½“å£°
                const audioPtr = nsfPlayer._malloc(audioDataSize);
                
                // è°ƒç”¨WebAssemblyå‡½æ•°ç”ŸæˆéŸ³é¢‘
                const result = nsfPlayer.ccall('nsf_render_audio', 'number',
                    ['number', 'number', 'number'], [currentTrack, frameCount, audioPtr]);
                
                if (result > 0) {
                    // è¯»å–ç”Ÿæˆçš„éŸ³é¢‘æ•°æ®
                    const int16Data = new Int16Array(nsfPlayer.HEAPU8.buffer, audioPtr, frameCount * channels);
                    
                    // è½¬æ¢ä¸ºFloat32å¹¶å¡«å……è¾“å‡ºç¼“å†²åŒº
                    for (let channel = 0; channel < channels; channel++) {
                        const outputData = outputBuffer.getChannelData(channel);
                        for (let sample = 0; sample < frameCount; sample++) {
                            const sampleIndex = sample * channels + channel;
                            outputData[sample] = int16Data[sampleIndex] / 32768.0;
                        }
                    }
                    
                    // æ›´æ–°æ³¢å½¢æ˜¾ç¤º
                    updateWaveform(outputBuffer.getChannelData(0));
                } else {
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¾“å‡ºé™éŸ³
                    for (let channel = 0; channel < channels; channel++) {
                        const outputData = outputBuffer.getChannelData(channel);
                        outputData.fill(0);
                    }
                }
                
                nsfPlayer._free(audioPtr);
                
            } catch (error) {
                console.error('éŸ³é¢‘ç”Ÿæˆé”™è¯¯:', error);
                // è¾“å‡ºé™éŸ³
                for (let channel = 0; channel < channels; channel++) {
                    const outputData = outputBuffer.getChannelData(channel);
                    outputData.fill(0);
                }
            }
        }

        // æ›´æ–°æ³¢å½¢æ˜¾ç¤º
        function updateWaveform(audioData) {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const sliceWidth = canvas.width / audioData.length;
            let x = 0;
            
            for (let i = 0; i < audioData.length; i++) {
                const v = audioData[i] * 0.5;
                const y = (v + 1) * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
        }

        // åŠ è½½NSFæ–‡ä»¶
        async function loadNSF() {
            const fileInput = document.getElementById('nsfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('è¯·é€‰æ‹©ä¸€ä¸ªNSFæ–‡ä»¶', 'error');
                return;
            }

            showStatus('æ­£åœ¨åˆå§‹åŒ–...', 'info');
            if (!(await initWasm())) return;

            showStatus('æ­£åœ¨åŠ è½½NSFæ–‡ä»¶...', 'info');

            try {
                // è¯»å–æ–‡ä»¶
                const arrayBuffer = await file.arrayBuffer();
                const nsfData = new Uint8Array(arrayBuffer);

                // åˆå§‹åŒ–æ’­æ”¾å™¨
                const initResult = nsfPlayer.ccall('init_nsf_player', 'number', [], []);
                if (!initResult) {
                    throw new Error('åˆå§‹åŒ–NSFæ’­æ”¾å™¨å¤±è´¥');
                }

                // åŠ è½½æ•°æ®
                const dataPtr = nsfPlayer._malloc(nsfData.length);
                nsfPlayer.HEAPU8.set(nsfData, dataPtr);
                const loadResult = nsfPlayer.ccall('load_nsf_data', 'number', 
                    ['number', 'number'], [dataPtr, nsfData.length]);
                nsfPlayer._free(dataPtr);

                if (!loadResult) {
                    throw new Error('åŠ è½½NSFæ•°æ®å¤±è´¥');
                }

                // è·å–ä¿¡æ¯
                const infoPtr = nsfPlayer._malloc(1024);
                const infoResult = nsfPlayer.ccall('get_nsf_info', 'number', ['number'], [infoPtr]);

                if (infoResult) {
                    nsfInfo = {
                        title: nsfPlayer.UTF8ToString(infoPtr),
                        artist: nsfPlayer.UTF8ToString(infoPtr + 256),
                        copyright: nsfPlayer.UTF8ToString(infoPtr + 512),
                        totalSongs: nsfPlayer.getValue(infoPtr + 768, 'i32'),
                        defaultSong: nsfPlayer.getValue(infoPtr + 772, 'i32'),
                        lengthMs: nsfPlayer.getValue(infoPtr + 776, 'i32'),
                        fadeMs: nsfPlayer.getValue(infoPtr + 780, 'i32')
                    };

                    displayNSFInfo();
                    setupTrackSelector();
                    
                    // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
                    if (await initAudio()) {
                        // è®¾ç½®C++æ’­æ”¾å™¨å‚æ•°
                        nsfPlayer.ccall('nsf_player_set_options', 'void', ['number', 'number'], [sampleRate, channels]);
                        
                        document.getElementById('playerContainer').classList.remove('hidden');
                        showStatus('NSFæ–‡ä»¶åŠ è½½æˆåŠŸï¼å¯ä»¥å¼€å§‹å®æ—¶æ’­æ”¾äº†ã€‚', 'success');
                    }
                } else {
                    throw new Error('è·å–NSFä¿¡æ¯å¤±è´¥');
                }

                nsfPlayer._free(infoPtr);

            } catch (error) {
                showStatus('åŠ è½½å¤±è´¥: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        // æ˜¾ç¤ºNSFä¿¡æ¯
        function displayNSFInfo() {
            const infoDiv = document.getElementById('nsfInfo');
            infoDiv.innerHTML = `
                <div class="bg-black/20 p-3 rounded-lg"><strong>æ ‡é¢˜:</strong> ${nsfInfo.title || 'æœªçŸ¥'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>è‰ºæœ¯å®¶:</strong> ${nsfInfo.artist || 'æœªçŸ¥'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>ç‰ˆæƒ:</strong> ${nsfInfo.copyright || 'æœªçŸ¥'}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>è½¨é“æ•°:</strong> ${nsfInfo.totalSongs}</div>
                <div class="bg-black/20 p-3 rounded-lg"><strong>é»˜è®¤è½¨é“:</strong> ${nsfInfo.defaultSong + 1}</div>
            `;
            document.getElementById('infoContainer').classList.remove('hidden');
        }

        // è®¾ç½®è½¨é“é€‰æ‹©å™¨
        function setupTrackSelector() {
            const trackSelect = document.getElementById('trackSelect');
            trackSelect.innerHTML = '';
            
            for (let i = 1; i <= nsfInfo.totalSongs; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `è½¨é“ ${i}`;
                option.className = 'bg-gray-800 text-white';
                if (i === nsfInfo.defaultSong + 1) {
                    option.selected = true;
                    currentTrack = i;
                }
                trackSelect.appendChild(option);
            }
            
            trackSelect.addEventListener('change', (e) => {
                const newTrack = parseInt(e.target.value);
                if (newTrack !== currentTrack) {
                    currentTrack = newTrack;
                    // é‡ç½®æ’­æ”¾å™¨åˆ°æ–°è½¨é“
                    if (nsfPlayer) {
                        nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                        nsfPlayer.ccall('nsf_reset', 'void', [], []);
                    }
                    updateCurrentTrackDisplay();
                }
            });
        }

        // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
        async function togglePlay() {
            if (!audioContext || !nsfPlayer) return;
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }

        // å¼€å§‹æ’­æ”¾
        function startPlay() {
            if (!nsfPlayer) return;
            
            isPlaying = true;
            playStartTime = Date.now();
            
            // è®¾ç½®æ’­æ”¾å™¨
            nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
            nsfPlayer.ccall('nsf_reset', 'void', [], []);
            
            // æ›´æ–°UI
            document.getElementById('playBtn').textContent = 'â¸ï¸ æš‚åœ';
            document.getElementById('playStatus').textContent = 'æ’­æ”¾ä¸­';
            document.getElementById('currentTrack').textContent = `è½¨é“ ${currentTrack}`;
            document.getElementById('bufferStatus').textContent = 'å®æ—¶ç”Ÿæˆ';
            
            // å¼€å§‹æ’­æ”¾æ—¶é—´æ›´æ–°
            startPlayTimer();
            
            showStatus('å¼€å§‹å®æ—¶æ’­æ”¾...', 'success');
        }

        // åœæ­¢æ’­æ”¾
        function stopPlay() {
            isPlaying = false;
            
            // æ›´æ–°UI
            document.getElementById('playBtn').textContent = 'â–¶ï¸ æ’­æ”¾';
            document.getElementById('playStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('playTime').textContent = '00:00';
            document.getElementById('bufferStatus').textContent = '-';
            
            stopPlayTimer();
            showStatus('æ’­æ”¾å·²åœæ­¢', 'info');
        }

        // ä¸Šä¸€é¦–
        function prevTrack() {
            if (currentTrack > 1) {
                currentTrack--;
                document.getElementById('trackSelect').value = currentTrack;
                if (nsfPlayer) {
                    nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                    nsfPlayer.ccall('nsf_reset', 'void', [], []);
                }
                updateCurrentTrackDisplay();
            }
        }

        // ä¸‹ä¸€é¦–
        function nextTrack() {
            if (currentTrack < nsfInfo.totalSongs) {
                currentTrack++;
                document.getElementById('trackSelect').value = currentTrack;
                if (nsfPlayer) {
                    nsfPlayer.ccall('nsf_set_track', 'void', ['number'], [currentTrack - 1]);
                    nsfPlayer.ccall('nsf_reset', 'void', [], []);
                }
                updateCurrentTrackDisplay();
            }
        }

        // æ›´æ–°å½“å‰è½¨é“æ˜¾ç¤º
        function updateCurrentTrackDisplay() {
            document.getElementById('currentTrack').textContent = `è½¨é“ ${currentTrack}`;
        }

        // æ’­æ”¾æ—¶é—´è®¡æ—¶å™¨
        let playTimer = null;

        function startPlayTimer() {
            playTimer = setInterval(() => {
                if (isPlaying) {
                    const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('playTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopPlayTimer() {
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            showStatus('å‡†å¤‡å°±ç»ªï¼Œè¯·é€‰æ‹©NSFæ–‡ä»¶å¼€å§‹å®æ—¶æ’­æ”¾');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (audioContext) {
                audioContext.close();
            }
            if (nsfPlayer) {
                nsfPlayer.ccall('cleanup', 'void', [], []);
            }
        });
    </script>
</body>
</html>
